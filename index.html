<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jam Digital Waktu Solat Masjid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a192f;
            color: #e6f1ff;
            transition: background-image 0.5s ease-in-out;
        }
        .glass-panel {
            background: rgba(13, 38, 76, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        .next-prayer {
            background-color: #17a2b8;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(23, 162, 184, 0.7);
        }
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            box-sizing: border-box;
        }
        .marquee-text {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 30s linear infinite;
        }
        @keyframes marquee {
            0%   { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto space-y-6">
        <!-- HEADER -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-6xl font-extrabold text-cyan-300 tracking-wide">Jam Waktu Solat Digital</h1>
            <div class="mt-4">
                <label for="zone-select" class="sr-only">Pilih Zon</label>
                <select id="zone-select" class="w-full max-w-md mx-auto bg-slate-700 text-white border border-slate-500 rounded-lg p-3 text-lg focus:ring-2 focus:ring-cyan-400 focus:outline-none">
                    <option value="JHR01">JHR01 - Pulau Aur dan Pulau Pemanggil</option>
                    <option value="JHR02">JHR02 - Johor Bahru, Kota Tinggi, Kulai</option>
                    <option value="JHR03">JHR03 - Kluang, Mersing</option>
                    <option value="JHR04">JHR04 - Batu Pahat, Muar, Segamat, Gemas Johor</option>
                    <option value="KDH01">KDH01 - Kota Setar, Kubang Pasu, Pokok Sena (Daerah Kecil)</option>
                    <option value="KDH02">KDH02 - Kuala Muda, Yan, Pendang</option>
                    <option value="KDH03">KDH03 - Padang Terap, Sik</option>
                    <option value="KDH04">KDH04 - Baling</option>
                    <option value="KDH05">KDH05 - Bandar Baharu, Kulim</option>
                    <option value="KDH06">KDH06 - Langkawi</option>
                    <option value="KDH07">KDH07 - Puncak Gunung Jerai</option>
                    <option value="KTN01">KTN01 - Bachok, Kota Bharu, Machang, Pasir Mas, Pasir Puteh, Tanah Merah, Tumpat, Kuala Krai, Mukim Chiku</option>
                    <option value="KTN03">KTN03 - Gua Musang (Daerah Galas Dan Bertam), Jeli</option>
                    <option value="MLK01">MLK01 - MELAKA</option>
                    <option value="NGS01">NGS01 - Tampin, Jempol</option>
                    <option value="NGS02">NGS02 - Jelebu, Kuala Pilah, Port Dickson, Rembau, Seremban</option>
                    <option value="PHG01">PHG01 - Pulau Tioman</option>
                    <option value="PHG02">PHG02 - Kuantan, Pekan, Rompin, Muadzam Shah</option>
                    <option value="PHG03">PHG03 - Jerantut, Temerloh, Maran, Bera, Chenor, Jengka</option>
                    <option value="PHG04">PHG04 - Bentong, Lipis, Raub</option>
                    <option value="PHG05">PHG05 - Genting Sempah, Janda Baik, Bukit Tinggi</option>
                    <option value="PHG06">PHG06 - Cameron Highlands, Genting Highlands, Bukit Fraser</option>
                    <option value="PLS01">PLS01 - Kangar, Padang Besar, Arau</option>
                    <option value="PNG01">PNG01 - Seluruh Negeri Pulau Pinang</option>
                    <option value="PRK01">PRK01 - Tapah, Slim River, Tanjung Malim</option>
                    <option value="PRK02">PRK02 - Kuala Kangsar, Sg. Siput (U), Ipoh, Batu Gajah, Kampar</option>
                    <option value="PRK03">PRK03 - Lenggong, Pengkalan Hulu, Grik</option>
                    <option value="PRK04">PRK04 - Temengor, Belum</option>
                    <option value="PRK05">PRK05 - Kg. Gajah, Teluk Intan, Bagan Datuk, Seri Iskandar, Beruas, Parit, Lumut, Sitiawan, Pulau Pangkor</option>
                    <option value="PRK06">PRK06 - Selama, Taiping, Bagan Serai, Parit Buntar</option>
                    <option value="PRK07">PRK07 - Bukit Larut</option>
                    <option value="SBH01">SBH01 - Bahagian Sandakan (Timur), Bukit Garam, Semawang, Temanggong, Tambisan, Bandar Sandakan, Sukau</option>
                    <option value="SBH02">SBH02 - Beluran, Telupid, Pinangah, Terusan, Kuamut, Bahagian Sandakan (Barat)</option>
                    <option value="SBH03">SBH03 - Lahad Datu, Silabukan, Kunak, Sahabat, Semporna, Tungku, Bahagian Tawau (Timur)</option>
                    <option value="SBH04">SBH04 - Bandar Tawau, Balong, Merotai, Kalabakan, Bahagian Tawau (Barat)</option>
                    <option value="SBH05">SBH05 - Kudat, Kota Marudu, Pitas, Pulau Banggi, Bahagian Kudat</option>
                    <option value="SBH06">SBH06 - Gunung Kinabalu</option>
                    <option value="SBH07">SBH07 - Kota Kinabalu, Ranau, Kota Belud, Tuaran, Penampang, Papar, Putatan, Bahagian Pantai Barat</option>
                    <option value="SBH08">SBH08 - Pensiangan, Keningau, Tambunan, Nabawan, Bahagian Pedalaman (Atas)</option>
                    <option value="SBH09">SBH09 - Beaufort, Kuala Penyu, Sipitang, Tenom, Long Pa Sia, Membakut, Weston, Bahagian Pedalaman (Bawah)</option>
                    <option value="SGR01" selected>SGR01 - Gombak, Petaling, Sepang, Hulu Langat, Hulu Selangor, S.Alam</option>
                    <option value="SGR02">SGR02 - Kuala Selangor, Sabak Bernam</option>
                    <option value="SGR03">SGR03 - Klang, Kuala Langat</option>
                    <option value="SWK01">SWK01 - Limbang, Lawas, Sundar, Trusan</option>
                    <option value="SWK02">SWK02 - Miri, Niah, Bekenu, Sibuti, Marudi</option>
                    <option value="SWK03">SWK03 - Pandan, Belaga, Suai, Tatau, Sebauh, Bintulu</option>
                    <option value="SWK04">SWK04 - Sibu, Mukah, Dalat, Song, Igan, Oya, Balingian, Kanowit, Kapit</option>
                    <option value="SWK05">SWK05 - Sarikei, Matu, Julau, Rajang, Daro, Bintangor, Belawai</option>
                    <option value="SWK06">SWK06 - Lubok Antu, Sri Aman, Roban, Debak, Kabong, Lingga, Engkelili, Betong, Pusa, Saratok</option>
                    <option value="SWK07">SWK07 - Serian, Simunjan, Samarahan, Sebuyau, Meludam</option>
                    <option value="SWK08">SWK08 - Kuching, Bau, Lundu, Sematan</option>
                    <option value="SWK09">SWK09 - Zon Khas (Kampung Patarikan)</option>
                    <option value="TRG01">TRG01 - Kuala Terengganu, Marang, Kuala Nerus</option>
                    <option value="TRG02">TRG02 - Besut, Setiu</option>
                    <option value="TRG03">TRG03 - Hulu Terengganu</option>
                    <option value="TRG04">TRG04 - Dungun, Kemaman</option>
                    <option value="WLY01">WLY01 - Kuala Lumpur, Putrajaya</option>
                    <option value="WLY02">WLY02 - Labuan</option>
                </select>
            </div>
        </header>

        <!-- Jam & Tarikh Semasa -->
        <div class="glass-panel p-6 text-center">
            <h2 id="current-time" class="text-6xl md:text-8xl font-black tracking-tighter">--:--:--</h2>
            <p id="current-date" class="text-lg md:text-xl text-slate-300 mt-2">Memuatkan...</p>
        </div>

        <!-- Prayer Times Panel -->
        <div class="glass-panel p-6">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 text-center">
                <div id="subuh" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">SUBUH</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
                <div id="syuruk" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">SYURUK</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
                <div id="zohor" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">ZOHOR</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
                <div id="asar" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">ASAR</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
                <div id="maghrib" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">MAGHRIB</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
                <div id="isyak" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">ISYAK</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
            </div>
        </div>

        <!-- Scrolling Text Panel -->
        <div id="scrolling-text-container" class="glass-panel p-4" style="display: none;">
            <div class="marquee-container">
                <p id="scrolling-text-display" class="marquee-text"></p>
            </div>
        </div>

        <!-- Static Memo Panel -->
        <div id="static-memo-container" class="glass-panel p-6" style="display: none;">
            <h3 class="text-lg font-semibold text-cyan-300 mb-2">Notis / Pengumuman</h3>
            <p id="static-memo-display" class="text-slate-300 whitespace-pre-wrap"></p>
        </div>
        
        <!-- Countdown & Next Prayer -->
        <div class="glass-panel p-6 text-center">
            <h3 class="text-lg font-semibold text-cyan-300">MASA BERBAKI KE <span id="next-prayer">...</span></h3>
            <p id="countdown" class="text-5xl font-bold mt-2">--:--:--</p>
        </div>
        
        <footer class="text-center text-slate-400 text-sm mt-8">
             <p>Copyright @ MAB Tech Synergy 2025 | <a href="admin.html" class="text-cyan-400 hover:underline">Admin Panel</a></p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Konfigurasi Firebase untuk aplikasi web anda
        const firebaseConfig = {
            apiKey: "AIzaSyCXzgZhN6ZVDfu_bhRW_Wf0rmEpC1QNi5Q",
            authDomain: "jam-waktu-solat.firebaseapp.com",
            databaseURL: "https://jam-waktu-solat-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jam-waktu-solat",
            storageBucket: "jam-waktu-solat.appspot.com",
            messagingSenderId: "195350385788",
            appId: "1:195350385788:web:90adc0ebfc1e27ec2725f9",
            measurementId: "G-CK12K8WXGH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
    
        let prayerTimesData = {};
        let nextPrayerInfo = null;
        
        const prayerTimeDisplays = document.querySelectorAll('.time-display');
        const zoneSelect = document.getElementById('zone-select');
        const countdownDisplay = document.getElementById('countdown');
        const nextPrayerDisplay = document.getElementById('next-prayer');
        const currentTimeEl = document.getElementById('current-time');
        const currentDateEl = document.getElementById('current-date');
        const scrollingTextDisplay = document.getElementById('scrolling-text-display');
        const staticMemoDisplay = document.getElementById('static-memo-display');
        const scrollingTextContainer = document.getElementById('scrolling-text-container');
        const staticMemoContainer = document.getElementById('static-memo-container');

        const prayerTimeDivs = {
            Subuh: document.getElementById('subuh'),
            Syuruk: document.getElementById('syuruk'),
            Zohor: document.getElementById('zohor'),
            Asar: document.getElementById('asar'),
            Maghrib: document.getElementById('maghrib'),
            Isyak: document.getElementById('isyak'),
        };
        
        const fetchPrayerTimes = async (zone) => {
            const apiUrl = `https://www.e-solat.gov.my/index.php?r=esolatApi/takwimsolat&period=today&zone=${zone}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Ralat API (status ${response.status})`);
                const data = await response.json();
                if (!data.prayerTime || data.prayerTime.length === 0) throw new Error('Data API tidak sah.');
                
                const todayPrayer = data.prayerTime[0];
                const formatTime = (timeStr) => {
                    if (!timeStr) return '--:--';
                    const date = new Date(`1970-01-01T${timeStr}`);
                    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                };
                
                prayerTimesData = {
                    Subuh: formatTime(todayPrayer.fajr),
                    Syuruk: formatTime(todayPrayer.syuruk),
                    Zohor: formatTime(todayPrayer.dhuhr),
                    Asar: formatTime(todayPrayer.asr),
                    Maghrib: formatTime(todayPrayer.maghrib),
                    Isyak: formatTime(todayPrayer.isha)
                };
                updatePrayerTimeUI();
                findNextPrayer(new Date());
            } catch (err) {
                console.error("Ralat ambil data:", err);
                nextPrayerDisplay.textContent = `Ralat: ${err.message}`;
                prayerTimeDisplays.forEach(el => el.textContent = 'Ralat');
            }
        };
        
        const updatePrayerTimeUI = () => {
            for (const prayer in prayerTimesData) {
                const div = prayerTimeDivs[prayer];
                if (div) {
                    const timeEl = div.querySelector('.time-display');
                    if (timeEl) timeEl.textContent = prayerTimesData[prayer];
                }
            }
        };
        
        const findNextPrayer = (now) => {
            const buildDateFromHM = (dateObj, hm) => {
                if (!hm || hm === '--:--') return null;
                const [hours, minutes] = hm.split(':');
                const d = new Date(dateObj);
                d.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                return d;
            };
        
            const order = ['Subuh', 'Zohor', 'Asar', 'Maghrib', 'Isyak'];
            let nextPrayer = null;
        
            for (const name of order) {
                const time = buildDateFromHM(now, prayerTimesData[name]);
                if (time && time > now) {
                    nextPrayer = { name, time };
                    break;
                }
            }
        
            if (!nextPrayer && prayerTimesData.Subuh) {
                const tomorrow = new Date(now);
                tomorrow.setDate(now.getDate() + 1);
                nextPrayer = { name: 'Subuh', time: buildDateFromHM(tomorrow, prayerTimesData.Subuh) };
            }
        
            nextPrayerInfo = nextPrayer;
            updateNextPrayerUI();
        };
        
        const updateNextPrayerUI = () => {
            Object.values(prayerTimeDivs).forEach(div => div.classList.remove('next-prayer'));
            if (nextPrayerInfo && prayerTimeDivs[nextPrayerInfo.name]) {
                prayerTimeDivs[nextPrayerInfo.name].classList.add('next-prayer');
            }
            if (!nextPrayerInfo) {
                nextPrayerDisplay.textContent = "Tiada maklumat";
                countdownDisplay.textContent = "--:--:--";
                return;
            }
            nextPrayerDisplay.textContent = `${nextPrayerInfo.name.toUpperCase()} (${nextPrayerInfo.time.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})})`;
        };
        
        const updateCountdown = () => {
            if (!nextPrayerInfo) return;
            const now = new Date();
            const diff = nextPrayerInfo.time - now;
            if (diff <= 0) {
                setTimeout(() => fetchPrayerTimes(zoneSelect.value), 2000);
                countdownDisplay.textContent = "00:00:00";
                return;
            }
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            countdownDisplay.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        };

        const updateClock = () => {
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('ms-MY', { hour12: false });
            currentDateEl.textContent = now.toLocaleDateString('ms-MY', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
        };

        const listenToFirebaseData = () => {
            const dataRef = ref(db, 'paparan/');
            onValue(dataRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const mesej = data.mesej || '';
                    const memo = data.memo || '';
                    const gambar = data.gambar || '';

                    // Kemas kini teks bergerak
                    if (mesej.trim() !== '') {
                        scrollingTextDisplay.textContent = mesej;
                        scrollingTextContainer.style.display = 'block';
                    } else {
                        scrollingTextContainer.style.display = 'none';
                    }

                    // Kemas kini memo statik
                    if (memo.trim() !== '') {
                        staticMemoDisplay.textContent = memo;
                        staticMemoContainer.style.display = 'block';
                    } else {
                        staticMemoContainer.style.display = 'none';
                    }

                    // Kemas kini gambar latar
                    if (gambar.trim() !== '') {
                        document.body.style.backgroundImage = `url('${gambar}')`;
                        document.body.style.backgroundSize = 'cover';
                        document.body.style.backgroundPosition = 'center';
                        document.body.style.backgroundAttachment = 'fixed';
                    } else {
                        document.body.style.backgroundImage = 'none';
                    }
                } else {
                    // Sembunyikan jika tiada data di Firebase
                    scrollingTextContainer.style.display = 'none';
                    staticMemoContainer.style.display = 'none';
                    document.body.style.backgroundImage = 'none';
                }
            }, (error) => {
                console.error("Firebase read failed: " + error.name);
            });
        };
        
        zoneSelect.addEventListener('change', (e) => fetchPrayerTimes(e.target.value));
        
        window.addEventListener('DOMContentLoaded', () => {
            const initialZone = zoneSelect.value || 'SGR01';
            fetchPrayerTimes(initialZone);
            updateClock();
            listenToFirebaseData(); // Mula mendengar data dari Firebase

            setInterval(() => {
                updateClock();
                updateCountdown();
            }, 1000);
            
            setInterval(() => {
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 1) {
                    fetchPrayerTimes(zoneSelect.value);
                }
            }, 60000);
        });
    </script>
</body>
</html>

