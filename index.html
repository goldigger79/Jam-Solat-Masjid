<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jam Digital Waktu Solat Masjid</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a192f;
            color: #e6f1ff;
            transition: background-image 0.5s ease-in-out;
        }
        .glass-panel {
            background: rgba(13, 38, 76, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        .next-prayer {
            background-color: #17a2b8;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(23, 162, 184, 0.7);
        }
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            box-sizing: border-box;
        }
        .marquee-text {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 30s linear infinite;
        }
        /* Cadangan F: Jeda animasi marquee apabila tetikus berada di atasnya */
        .marquee-container:hover .marquee-text {
            animation-play-state: paused;
        }
        @keyframes marquee {
            0%   { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto space-y-6">
        <!-- HEADER -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-6xl font-extrabold text-cyan-300 tracking-wide">Jam Waktu Solat Digital</h1>
            <div class="mt-4">
                <label for="zone-select" class="sr-only">Pilih Zon</label>
                <!-- Cadangan A: Menggunakan <optgroup> untuk mengumpulkan zon mengikut negeri -->
                <select id="zone-select" class="w-full max-w-md mx-auto bg-slate-700 text-white border border-slate-500 rounded-lg p-3 text-lg focus:ring-2 focus:ring-cyan-400 focus:outline-none">
                    <optgroup label="Johor">
                        <option value="JHR01">JHR01 - Pulau Aur dan Pulau Pemanggil</option>
                        <option value="JHR02">JHR02 - Johor Bahru, Kota Tinggi, Kulai</option>
                        <option value="JHR03">JHR03 - Kluang, Mersing</option>
                        <option value="JHR04">JHR04 - Batu Pahat, Muar, Segamat, Gemas Johor</option>
                    </optgroup>
                    <optgroup label="Kedah">
                        <option value="KDH01">KDH01 - Kota Setar, Kubang Pasu, Pokok Sena (Daerah Kecil)</option>
                        <option value="KDH02">KDH02 - Kuala Muda, Yan, Pendang</option>
                        <option value="KDH03">KDH03 - Padang Terap, Sik</option>
                        <option value="KDH04">KDH04 - Baling</option>
                        <option value="KDH05">KDH05 - Bandar Baharu, Kulim</option>
                        <option value="KDH06">KDH06 - Langkawi</option>
                        <option value="KDH07">KDH07 - Puncak Gunung Jerai</option>
                    </optgroup>
                    <optgroup label="Kelantan">
                        <option value="KTN01">KTN01 - Bachok, Kota Bharu, Machang, Pasir Mas, Pasir Puteh, Tanah Merah, Tumpat, Kuala Krai, Mukim Chiku</option>
                        <option value="KTN03">KTN03 - Gua Musang (Daerah Galas Dan Bertam), Jeli</option>
                    </optgroup>
                    <optgroup label="Melaka">
                        <option value="MLK01">MLK01 - MELAKA</option>
                    </optgroup>
                    <optgroup label="Negeri Sembilan">
                        <option value="NGS01">NGS01 - Tampin, Jempol</option>
                        <option value="NGS02">NGS02 - Jelebu, Kuala Pilah, Port Dickson, Rembau, Seremban</option>
                    </optgroup>
                    <optgroup label="Pahang">
                        <option value="PHG01">PHG01 - Pulau Tioman</option>
                        <option value="PHG02">PHG02 - Kuantan, Pekan, Rompin, Muadzam Shah</option>
                        <option value="PHG03">PHG03 - Jerantut, Temerloh, Maran, Bera, Chenor, Jengka</option>
                        <option value="PHG04">PHG04 - Bentong, Lipis, Raub</option>
                        <option value="PHG05">PHG05 - Genting Sempah, Janda Baik, Bukit Tinggi</option>
                        <option value="PHG06">PHG06 - Cameron Highlands, Genting Highlands, Bukit Fraser</option>
                    </optgroup>
                    <optgroup label="Perlis">
                        <option value="PLS01">PLS01 - Kangar, Padang Besar, Arau</option>
                    </optgroup>
                    <optgroup label="Pulau Pinang">
                        <option value="PNG01">PNG01 - Seluruh Negeri Pulau Pinang</option>
                    </optgroup>
                    <optgroup label="Perak">
                        <option value="PRK01">PRK01 - Tapah, Slim River, Tanjung Malim</option>
                        <option value="PRK02">PRK02 - Kuala Kangsar, Sg. Siput (U), Ipoh, Batu Gajah, Kampar</option>
                        <option value="PRK03">PRK03 - Lenggong, Pengkalan Hulu, Grik</option>
                        <option value="PRK04">PRK04 - Temengor, Belum</option>
                        <option value="PRK05">PRK05 - Kg. Gajah, Teluk Intan, Bagan Datuk, Seri Iskandar, Beruas, Parit, Lumut, Sitiawan, Pulau Pangkor</option>
                        <option value="PRK06">PRK06 - Selama, Taiping, Bagan Serai, Parit Buntar</option>
                        <option value="PRK07">PRK07 - Bukit Larut</option>
                    </optgroup>
                    <optgroup label="Sabah">
                        <option value="SBH01">SBH01 - Bahagian Sandakan (Timur), Bukit Garam, Semawang, Temanggong, Tambisan, Bandar Sandakan, Sukau</option>
                        <option value="SBH02">SBH02 - Beluran, Telupid, Pinangah, Terusan, Kuamut, Bahagian Sandakan (Barat)</option>
                        <option value="SBH03">SBH03 - Lahad Datu, Silabukan, Kunak, Sahabat, Semporna, Tungku, Bahagian Tawau (Timur)</option>
                        <option value="SBH04">SBH04 - Bandar Tawau, Balong, Merotai, Kalabakan, Bahagian Tawau (Barat)</option>
                        <option value="SBH05">SBH05 - Kudat, Kota Marudu, Pitas, Pulau Banggi, Bahagian Kudat</option>
                        <option value="SBH06">SBH06 - Gunung Kinabalu</option>
                        <option value="SBH07">SBH07 - Kota Kinabalu, Ranau, Kota Belud, Tuaran, Penampang, Papar, Putatan, Bahagian Pantai Barat</option>
                        <option value="SBH08">SBH08 - Pensiangan, Keningau, Tambunan, Nabawan, Bahagian Pedalaman (Atas)</option>
                        <option value="SBH09">SBH09 - Beaufort, Kuala Penyu, Sipitang, Tenom, Long Pa Sia, Membakut, Weston, Bahagian Pedalaman (Bawah)</option>
                    </optgroup>
                    <optgroup label="Selangor">
                        <option value="SGR01" selected>SGR01 - Gombak, Petaling, Sepang, Hulu Langat, Hulu Selangor, S.Alam</option>
                        <option value="SGR02">SGR02 - Kuala Selangor, Sabak Bernam</option>
                        <option value="SGR03">SGR03 - Klang, Kuala Langat</option>
                    </optgroup>
                    <optgroup label="Sarawak">
                        <option value="SWK01">SWK01 - Limbang, Lawas, Sundar, Trusan</option>
                        <option value="SWK02">SWK02 - Miri, Niah, Bekenu, Sibuti, Marudi</option>
                        <option value="SWK03">SWK03 - Pandan, Belaga, Suai, Tatau, Sebauh, Bintulu</option>
                        <option value="SWK04">SWK04 - Sibu, Mukah, Dalat, Song, Igan, Oya, Balingian, Kanowit, Kapit</option>
                        <option value="SWK05">SWK05 - Sarikei, Matu, Julau, Rajang, Daro, Bintangor, Belawai</option>
                        <option value="SWK06">SWK06 - Lubok Antu, Sri Aman, Roban, Debak, Kabong, Lingga, Engkelili, Betong, Pusa, Saratok</option>
                        <option value="SWK07">SWK07 - Serian, Simunjan, Samarahan, Sebuyau, Meludam</option>
                        <option value="SWK08">SWK08 - Kuching, Bau, Lundu, Sematan</option>
                        <option value="SWK09">SWK09 - Zon Khas (Kampung Patarikan)</option>
                    </optgroup>
                    <optgroup label="Terengganu">
                        <option value="TRG01">TRG01 - Kuala Terengganu, Marang, Kuala Nerus</option>
                        <option value="TRG02">TRG02 - Besut, Setiu</option>
                        <option value="TRG03">TRG03 - Hulu Terengganu</option>
                        <option value="TRG04">TRG04 - Dungun, Kemaman</option>
                    </optgroup>
                    <optgroup label="Wilayah Persekutuan">
                        <option value="WLY01">WLY01 - Kuala Lumpur, Putrajaya</option>
                        <option value="WLY02">WLY02 - Labuan</option>
                    </optgroup>
                </select>
                
                <!-- Butang GPS Baru -->
                <button id="gps-button" class="mt-4 w-full max-w-md mx-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                    </svg>
                    <span id="gps-button-text">Guna Lokasi Saya</span>
                </button>
                <!-- /Butang GPS Baru -->
                
            </div>
        </header>

        <!-- Jam & Tarikh Semasa -->
        <div class="glass-panel p-6 text-center">
            <h2 id="current-time" class="text-6xl md:text-8xl font-black tracking-tighter">--:--:--</h2>
            <p id="current-date" class="text-lg md:text-xl text-slate-300 mt-2">Memuatkan...</p>
            <!-- Cadangan C: Elemen baru untuk tarikh Hijrah -->
            <p id="hijri-date" class="text-lg md:text-xl text-cyan-400 mt-1"></p>
        </div>

        <!-- Prayer Times Panel -->
        <div class="glass-panel p-6">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 text-center">
                <div id="subuh" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">SUBUH</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
                <div id="syuruk" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">SYURUK</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
                <div id="zohor" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">ZOHOR</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
                <div id="asar" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">ASAR</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
                <div id="maghrib" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">MAGHRIB</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
                <div id="isyak" class="p-4 bg-slate-800 rounded-lg transition-all duration-300">
                    <h3 class="text-sm font-semibold text-slate-400">ISYAK</h3>
                    <p class="text-2xl font-bold time-display">--:--</p>
                </div>
            </div>
        </div>

        <!-- Scrolling Text Panel -->
        <div id="scrolling-text-container" class="glass-panel p-4" style="display: none;">
            <div class="marquee-container">
                <p id="scrolling-text-display" class="marquee-text"></p>
            </div>
        </div>

        <!-- Static Memo Panel -->
        <div id="static-memo-container" class="glass-panel p-6" style="display: none;">
            <h3 class="text-lg font-semibold text-cyan-300 mb-2">Notis / Pengumuman</h3>
            <p id="static-memo-display" class="text-slate-300 whitespace-pre-wrap"></p>
        </div>
        
        <!-- Countdown & Next Prayer -->
        <div class="glass-panel p-6 text-center">
            <h3 class="text-lg font-semibold text-cyan-300">MASA BERBAKI KE <span id="next-prayer">...</span></h3>
            <p id="countdown" class="text-5xl font-bold mt-2">--:--:--</p>
        </div>
        
        <footer class="text-center text-slate-400 text-sm mt-8">
             <p>Copyright @ MAB Tech Synergy 2025</p>
        </footer>
    </div>

    <!-- Add to Home Screen Modal -->
    <div id="pwa-install-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="glass-panel text-center p-8 rounded-2xl max-w-sm w-full">
            <h2 class="text-2xl font-bold text-cyan-300">Pasang Aplikasi Ini</h2>
            <p class="mt-4 text-base">Pasang aplikasi ini pada peranti anda untuk akses yang lebih mudah dan pantas.</p>
            <div class="mt-8 flex gap-4">
                <button id="pwa-install-btn" class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Pasang</button>
                <button id="pwa-dismiss-btn" class="flex-1 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Nanti Dulu</button>
            </div>
        </div>
    </div>

    <!-- Prayer Time Notification Modal -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="glass-panel text-center p-8 rounded-2xl max-w-sm w-full">
            <h2 id="notification-title" class="text-3xl font-bold text-cyan-300"></h2>
            <p class="mt-4 text-lg">Selamat menunaikan solat.</p>
            <button id="notification-close-btn" class="mt-8 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-8 rounded-lg transition-colors">Tutup</button>
        </div>
    </div>


    <script type="module">
        /* Cadangan G: Kemas kini versi Firebase */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Konfigurasi Firebase untuk aplikasi web anda
        const firebaseConfig = {
            apiKey: "AIzaSyCXzgZhN6ZVDfu_bhRW_Wf0rmEpC1QNi5Q",
            authDomain: "jam-waktu-solat.firebaseapp.com",
            databaseURL: "https://jam-waktu-solat-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jam-waktu-solat",
            storageBucket: "jam-waktu-solat.appspot.com",
            messagingSenderId: "195350385788",
            appId: "1:195350385788:web:90adc0ebfc1e27ec2725f9",
            measurementId: "G-CK12K8WXGH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
    
        let prayerTimesData = {};
        let nextPrayerInfo = null;
        let hasNotifiedForCurrentPrayer = false;
        let audioContext;
        
        const prayerTimeDisplays = document.querySelectorAll('.time-display');
        const zoneSelect = document.getElementById('zone-select');
        const gpsButton = document.getElementById('gps-button'); // Tambah butang GPS
        const gpsButtonText = document.getElementById('gps-button-text'); // Tambah teks butang GPS
        const countdownDisplay = document.getElementById('countdown');
        const nextPrayerDisplay = document.getElementById('next-prayer');
        const currentTimeEl = document.getElementById('current-time');
        const currentDateEl = document.getElementById('current-date');
        const hijriDateEl = document.getElementById('hijri-date'); // Cadangan C: Pembolehubah untuk tarikh Hijrah
        const scrollingTextDisplay = document.getElementById('scrolling-text-display');
        const staticMemoDisplay = document.getElementById('static-memo-display');
        const scrollingTextContainer = document.getElementById('scrolling-text-container');
        const staticMemoContainer = document.getElementById('static-memo-container');
        
        // Notification Modal Elements
        const notificationModal = document.getElementById('notification-modal');
        const notificationTitle = document.getElementById('notification-title');
        const notificationCloseBtn = document.getElementById('notification-close-btn');

        const prayerTimeDivs = {
            Subuh: document.getElementById('subuh'),
            Syuruk: document.getElementById('syuruk'),
            Zohor: document.getElementById('zohor'),
            Asar: document.getElementById('asar'),
            Maghrib: document.getElementById('maghrib'),
            Isyak: document.getElementById('isyak'),
        };
        
        const fetchPrayerTimes = async (zone) => {
            const apiUrl = `https://www.e-solat.gov.my/index.php?r=esolatApi/takwimsolat&period=today&zone=${zone}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Ralat API (status ${response.status})`);
                const data = await response.json();
                if (!data.prayerTime || data.prayerTime.length === 0) throw new Error('Data API tidak sah.');
                
                const todayPrayer = data.prayerTime[0];
                const hijriDate = todayPrayer.hijri; // Cadangan C: Ambil tarikh Hijri
                hijriDateEl.textContent = hijriDate; // Cadangan C: Papar tarikh Hijri

                const formatTime = (timeStr) => {
                    if (!timeStr) return '--:--';
                    const date = new Date(`1970-01-01T${timeStr}`);
                    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                };
                
                prayerTimesData = {
                    Subuh: formatTime(todayPrayer.fajr),
                    Syuruk: formatTime(todayPrayer.syuruk),
                    Zohor: formatTime(todayPrayer.dhuhr),
                    Asar: formatTime(todayPrayer.asr),
                    Maghrib: formatTime(todayPrayer.maghrib),
                    Isyak: formatTime(todayPrayer.isha),
                    Hijri: hijriDate // Cadangan C & E: Simpan Hijri untuk cache
                };
                updatePrayerTimeUI();
                findNextPrayer(new Date());

                // Cadangan E: Simpan data berjaya ke cache
                const cacheData = {
                    date: new Date().toLocaleDateString('ms-MY'),
                    times: prayerTimesData
                };
                localStorage.setItem('prayerCache', JSON.stringify(cacheData));

            } catch (err) {
                console.error("Ralat ambil data:", err);

                // Cadangan E: Cuba muat dari cache jika API gagal
                const cached = localStorage.getItem('prayerCache');
                if (cached) {
                    const cacheData = JSON.parse(cached);
                    // Hanya guna cache jika ia adalah untuk hari ini
                    if (cacheData.date === new Date().toLocaleDateString('ms-MY')) {
                        prayerTimesData = cacheData.times;
                        updatePrayerTimeUI();
                        if (prayerTimesData.Hijri) {
                            hijriDateEl.textContent = prayerTimesData.Hijri;
                        }
                        findNextPrayer(new Date());
                        nextPrayerDisplay.textContent = "Mod Luar Talian";
                        return; // Berjaya muat dari cache
                    }
                }

                // Jika tiada cache atau cache sudah lama
                nextPrayerDisplay.textContent = `Ralat: ${err.message}`;
                prayerTimeDisplays.forEach(el => el.textContent = 'Ralat');
            }
        };
        
        const updatePrayerTimeUI = () => {
            for (const prayer in prayerTimesData) {
                const div = prayerTimeDivs[prayer];
                if (div) {
                    const timeEl = div.querySelector('.time-display');
                    if (timeEl) timeEl.textContent = prayerTimesData[prayer];
                }
            }
        };
        
        const findNextPrayer = (now) => {
            const buildDateFromHM = (dateObj, hm) => {
                if (!hm || hm === '--:--') return null;
                const [hours, minutes] = hm.split(':');
                const d = new Date(dateObj);
                d.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                return d;
            };
        
            const order = ['Subuh', 'Zohor', 'Asar', 'Maghrib', 'Isyak'];
            let nextPrayer = null;
        
            for (const name of order) {
                const time = buildDateFromHM(now, prayerTimesData[name]);
                if (time && time > now) {
                    nextPrayer = { name, time };
                    break;
                }
            }
        
            if (!nextPrayer && prayerTimesData.Subuh) {
                const tomorrow = new Date(now);
                tomorrow.setDate(now.getDate() + 1);
                nextPrayer = { name: 'Subuh', time: buildDateFromHM(tomorrow, prayerTimesData.Subuh) };
            }
        
            // Reset notification flag if the next prayer is different
            if (nextPrayerInfo && nextPrayer && nextPrayerInfo.name !== nextPrayer.name) {
                hasNotifiedForCurrentPrayer = false;
            }
            
            nextPrayerInfo = nextPrayer;
            updateNextPrayerUI();
        };
        
        const updateNextPrayerUI = () => {
            Object.values(prayerTimeDivs).forEach(div => div.classList.remove('next-prayer'));
            if (nextPrayerInfo && prayerTimeDivs[nextPrayerInfo.name]) {
                prayerTimeDivs[nextPrayerInfo.name].classList.add('next-prayer');
            }
            if (!nextPrayerInfo) {
                nextPrayerDisplay.textContent = "Tiada maklumat";
                countdownDisplay.textContent = "--:--:--";
                return;
            }
            nextPrayerDisplay.textContent = `${nextPrayerInfo.name.toUpperCase()} (${nextPrayerInfo.time.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})})`;
        };
        
        const updateCountdown = () => {
            if (!nextPrayerInfo) return;
            const now = new Date();
            const diff = nextPrayerInfo.time - now;

            if (diff <= 0) {
                if (!hasNotifiedForCurrentPrayer) {
                    showNotification(`Waktu ${nextPrayerInfo.name} Telah Masuk`);
                    hasNotifiedForCurrentPrayer = true;
                }
                setTimeout(() => fetchPrayerTimes(zoneSelect.value), 5000); // Refresh after 5s
                countdownDisplay.textContent = "00:00:00";
                return;
            }

            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            countdownDisplay.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        };

        const updateClock = () => {
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('ms-MY', { hour12: false });
            currentDateEl.textContent = now.toLocaleDateString('ms-MY', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
        };

        // --- PEMBETULAN: Menambah semula fungsi listenToFirebaseData ---
        const listenToFirebaseData = () => {
            const dataRef = ref(db, 'paparan/');
            onValue(dataRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const mesej = data.mesej || '';
                    const memo = data.memo || '';
                    const gambar = data.gambar || '';

                    // Kemas kini teks bergerak
                    if (mesej.trim() !== '') {
                        scrollingTextDisplay.textContent = mesej;
                        scrollingTextContainer.style.display = 'block';
                    } else {
                        scrollingTextContainer.style.display = 'none';
                    }

                    // Kemas kini memo statik
                    if (memo.trim() !== '') {
                        staticMemoDisplay.textContent = memo;
                        staticMemoContainer.style.display = 'block';
                    } else {
                        staticMemoContainer.style.display = 'none';
                    }

                    // Kemas kini gambar latar
                    if (gambar.trim() !== '') {
                        document.body.style.backgroundImage = `url('${gambar}')`;
                        document.body.style.backgroundSize = 'cover';
                        document.body.style.backgroundPosition = 'center';
                        document.body.style.backgroundAttachment = 'fixed';
                    } else {
                        document.body.style.backgroundImage = 'none';
                    }
                } else {
                    // Sembunyikan jika tiada data di Firebase
                    scrollingTextContainer.style.display = 'none';
                    staticMemoContainer.style.display = 'none';
                    document.body.style.backgroundImage = 'none';
                }
            }, (error) => {
                console.error("Firebase read failed: " + error.name);
            });
        };
        // --- /PEMBETULAN ---

        // --- Fungsi Geolocation ---

        const fetchZoneFromCoords = async (lat, long) => {
            // Menggunakan API e-Solat untuk menukar koordinat ke zon
            const apiUrl = `https://www.e-solat.gov.my/index.php?r=esolatApi/zonwaktusolat&lat=${lat}&long=${long}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('API e-Solat (koordinat) tidak berfungsi');
                const data = await response.json();
                
                if (data && data.zone) {
                    return data.zone; // Cth: "MLK01"
                } else {
                    throw new Error('Format data zon tidak sah');
                }
            } catch (err) {
                console.error("Ralat ambil zon dari koordinat:", err);
                gpsButtonText.textContent = "Gagal (API Zon)";
                setTimeout(() => gpsButtonText.textContent = "Guna Lokasi Saya", 3000);
                return null;
            }
        };

        const geolocationSuccess = async (position) => {
            const { latitude, longitude } = position.coords;
            gpsButtonText.textContent = "Mencari zon...";
            
            const zone = await fetchZoneFromCoords(latitude, longitude);
            
            if (zone) {
                zoneSelect.value = zone;
                // Cetuskan event 'change' untuk memuatkan waktu solat bagi zon baru
                zoneSelect.dispatchEvent(new Event('change'));
                gpsButtonText.textContent = "Lokasi Ditemui!";
                setTimeout(() => gpsButtonText.textContent = "Guna Lokasi Saya", 3000);
            } else {
                gpsButtonText.textContent = "Zon Tidak Ditemui";
                setTimeout(() => gpsButtonText.textContent = "Guna Lokasi Saya", 3000);
            }
        };

        const geolocationError = (err) => {
            console.warn(`RALAT Geolocation (${err.code}): ${err.message}`);
            let errorMsg = "Gagal dapatkan lokasi";
            if (err.code === 1) { // 1: PERMISSION_DENIED
                errorMsg = "Kebenaran Lokasi Ditolak";
            } else if (err.code === 2) { // 2: POSITION_UNAVAILABLE
                errorMsg = "Lokasi Tidak Tersedia";
            }
            gpsButtonText.textContent = errorMsg;
            setTimeout(() => gpsButtonText.textContent = "Guna Lokasi Saya", 3000);
        };

        const handleLocationClick = () => {
            if ('geolocation' in navigator) {
                gpsButtonText.textContent = "Meminta kebenaran...";
                navigator.geolocation.getCurrentPosition(geolocationSuccess, geolocationError, {
                    enableHighAccuracy: false, // Guna 'false' untuk jimat bateri & lebih pantas
                    timeout: 10000, // 10 saat
                    maximumAge: 0 // Paksa bacaan baru
                });
            } else {
                gpsButtonText.textContent = "GPS Tidak Disokong";
                setTimeout(() => gpsButtonText.textContent = "Guna Lokasi Saya", 3000);
            }
        };


        // --- Notification Functions ---
        const initAudio = () => {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.warn('Web Audio API is not supported in this browser.');
            }
        };

        const playSound = () => {
            if (!audioContext) return;
            const oscillator = audioContext.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 pitch
            oscillator.connect(audioContext.destination);
            oscillator.start();
            setTimeout(() => oscillator.stop(), 500); // Beep for 500ms
        };
        
        const showNotification = (message) => {
            notificationTitle.textContent = message;
            notificationModal.style.display = 'flex';
            playSound();
        };

        const hideNotification = () => {
            notificationModal.style.display = 'none';
        };
        
        // Cadangan B: Simpan pilihan zon ke localStorage
        zoneSelect.addEventListener('change', (e) => {
            const selectedZone = e.target.value;
            localStorage.setItem('prayerZone', selectedZone); // Simpan pilihan
            fetchPrayerTimes(selectedZone);
        });
        notificationCloseBtn.addEventListener('click', hideNotification);
        gpsButton.addEventListener('click', handleLocationClick); // Tambah listener butang GPS
        
        window.addEventListener('DOMContentLoaded', () => {
            initAudio();

            // Cadangan B: Muat zon dari localStorage semasa mula
            const savedZone = localStorage.getItem('prayerZone');
            const initialZone = savedZone || 'SGR01';
            zoneSelect.value = initialZone; // Tetapkan nilai dropdown
            
            fetchPrayerTimes(initialZone);
            updateClock();
            listenToFirebaseData(); // Mula mendengar data dari Firebase

            setInterval(() => {
                updateClock();
                updateCountdown();
            }, 1000);
            
            setInterval(() => {
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 1) {
                    fetchPrayerTimes(zoneSelect.value);
                    hasNotifiedForCurrentPrayer = false; // Reset notification for the new day
                }
            }, 60000);
        });

        // --- PWA Install Prompt ---
        let deferredPrompt;
        const pwaInstallModal = document.getElementById('pwa-install-modal');
        const pwaInstallBtn = document.getElementById('pwa-install-btn');
        const pwaDismissBtn = document.getElementById('pwa-dismiss-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Tunjukkan modal jika app belum dipasang
            if (!window.matchMedia('(display-mode: standalone)').matches) {
                pwaInstallModal.style.display = 'flex';
            }
        });

        pwaInstallBtn.addEventListener('click', async () => {
            pwaInstallModal.style.display = 'none';
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
        });

        pwaDismissBtn.addEventListener('click', () => {
            pwaInstallModal.style.display = 'none';
        });

        window.addEventListener('appinstalled', () => {
            pwaInstallModal.style.display = 'none';
            deferredPrompt = null;
            console.log('PWA was installed');
        });
    </script>
</body>
</html>

